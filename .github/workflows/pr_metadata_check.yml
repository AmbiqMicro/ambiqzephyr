name: PR Metadata Check

on:
  pull_request:
    types:
      - synchronize
      - opened
      - reopened
      - labeled
      - unlabeled
      - edited

permissions:
  contents: read
  pull-requests: read
  actions: read

jobs:
  do-not-merge:
    name: Prevent Merging
    runs-on: [self-hosted, Linux, zephyr-ci]
    env:
      BASE_REF: ${{ github.event.pull_request.base.ref }}
    steps:
      - name: Checkout
        if: github.event_name == 'pull_request'
        run: |
          sudo rm -rf "$GITHUB_WORKSPACE"/.??* "$GITHUB_WORKSPACE"/*
          GIT_REF="${{ github.event.pull_request.head.sha }}"
          CACHE_DIR="/data/ambiqzephyrcache/zephyrproject/zephyr"
          if [ -d "${CACHE_DIR}" ]; then
            echo "Cloning from local cache (${CACHE_DIR}) at ${GIT_REF}…"
            git clone --reference "${CACHE_DIR}" \
                      --depth 1 \
                      https://github.com/${{ github.repository }}.git "zephyr"
          else
            echo "Cache not found; doing fresh shallow clone at ${GIT_REF}…"
            git clone --depth 1 \
                      https://github.com/${{ github.repository }}.git "zephyr"
          fi
          cd "zephyr"
          git fetch origin "${BASE_REF}"
          git fetch origin "${GIT_REF}"
          git reset --hard "${GIT_REF}"
          git clean -fdx

      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: 3.12
          cache: pip
          cache-dependency-path: scripts/requirements-actions.txt

      - name: Install Python packages
        working-directory: zephyr
        run: |
          pip install -r scripts/requirements-actions.txt --require-hashes

      - name: Run the check script
        working-directory: zephyr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -u scripts/ci/do_not_merge.py -p "${{ github.event.pull_request.number }}"
